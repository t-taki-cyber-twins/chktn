# AIコーディングエージェント用メモリ情報

**基本重要事項**

- 英語で思考し、その結果を日本語で出力してください。
- 実装計画やウォークスルーなどのドキュメントも日本語で表示してください

## プロジェクト概要

**プロジェクト名**: エンジニア・案件マッチングシステム（chktn）

**目的**: エンジニア提供会社と案件提供会社をマッチングするプラットフォーム
- マルチテナント対応（複数の会社が同一システムを利用）
- テナント間でのデータ共有（公開設定による）
- エンジニアと案件のマッチング推薦

## 基礎構成

- **サービス構成**: API Gateway + Core Service（2サービス）
- **データベース**: Shared Database（単一データベース、単一スキーマ）


## 技術スタック

### 言語・フレームワーク
- **Java**: 21（JavaLanguageVersion.of(21)）
- **Spring Boot**: 3.5.7
- **Spring Cloud**: 2023.0.3
- **Gradle**: マルチプロジェクト構成（Kotlin DSL）

### データベース
- **PostgreSQL**: 17（postgres:17-alpine）
- **JDBCドライバ**: 42.7.3
- **マイグレーション**: Flyway 10.14.0

### その他
- **Lombok**: 1.18.34
- **SpringDoc OpenAPI**: 2.6.0（Swagger UI）
- **Docker**: コンテナ化対応


## プロジェクト構造

プロジェクト構造の詳細は [`docs/memory/project-structure.md`](docs/memory/project-structure.md) を参照してください。

## データベース設計

データベース設計の詳細は [`docs/memory/database-design.md`](docs/memory/database-design.md) を参照してください。

## 命名規則

### パッケージ
- ベースパッケージ: `jp.chokutuna`
- API Gateway: `jp.chokutuna.gateway`
- Core Service: `jp.chokutuna.core`
- モジュール: `jp.chokutuna.core.{module}`（company, engineer, project等）

### クラス名
- Applicationクラス: `{Service}Application.java`（例: `ApiGatewayApplication.java`, `CoreServiceApplication.java`）
- 設定クラス: `{Config}Config.java`（例: `OpenApiConfig.java`）

### データベース
- テーブル名: スネークケース、複数形（例: `companies`, `engineers`）
- カラム名: スネークケース（例: `tenant_id`, `is_public`）

## 重要な設計決定事項

### 1. マルチテナント対応
- テナントIDカラム方式を採用
- アプリケーションレベルでテナントIDによるフィルタリング
- 公開フラグ（`is_public`）でテナント間データ共有

### 2. API Gatewayの役割
- ルーティング（`/api/v1/**` → Core Service）
- 認証・認可（JWT検証、テナントID抽出・注入）
- 基本ログ記録
- フェーズ2でレートリミット、サーキットブレーカーを追加予定

### 3. データベース設計
- Shared Database（単一データベース、単一スキーマ）
- **タイムゾーン管理**: すべてのタイムスタンプ（`created_at`, `updated_at`）はUTCで保存
  - データベース側のDEFAULT値とトリガーで自動管理
  - Java側では`@PrePersist`/`@PreUpdate`を使用せず、カラムは`insertable = false, updatable = false`で読み取り専用
  - PostgreSQLの`CURRENT_TIMESTAMP`とトリガー関数を使用してUTC時刻を自動設定・更新

### 4. 環境変数管理
- `.env`ファイルを使用（Git除外）
- `.env.example`でテンプレート管理
- `docker-compose.yml`で`${VAR_NAME:-default}`形式で参照

## ポート番号・環境変数

インフラ情報（ポート番号・環境変数）の詳細は [`docs/memory/infrastructure.md`](docs/memory/infrastructure.md) を参照してください。

## 開発時の注意事項

### 1. モジュール分離の原則
- Core Service内でパッケージ単位でモジュール分離
- モジュール間の依存関係を最小化
- 将来的なサービス分割を考慮した設計

### 2. マルチテナント対応
- すべてのデータアクセスでテナントIDを考慮
- 公開データの取得時は`is_public = true`でフィルタリング
- 自社データの取得時は`tenant_id = currentTenantId`でフィルタリング

### 3. API設計
- RESTful API設計
- パス: `/api/v1/{resource}/**`
- テナントIDはHTTPヘッダー（`X-Tenant-ID`）で受け取る

### 4. バージョン管理
- バージョンカタログ（`gradle/libs.versions.toml`）で一元管理
- 依存関係の追加時はバージョンカタログを使用

### 5. Docker Compose
- 開発環境用（PostgreSQL 17使用）
- 本番環境ではAWS ECS/Fargateを使用する前提
- 環境変数は`.env`ファイルで管理

### 6. ワイヤーフレーム画面の確認
- **重要**: ワイヤーフレーム画面を確認する際は、必ずWebサーバー経由でアクセスする
- **URL形式**: `http://127.0.0.1:3000/docs/design/wireframe/XXXX.html`
- **禁止**: `file://` プロトコルでの直接アクセスは避ける
- **理由**: Web Components、JavaScriptモジュール、CORSなどが正しく動作するため
- **前提**: ユーザーがローカルでWebサーバー（ポート3000）を起動していることを想定
- **サーバーが起動していない場合**: ユーザーに起動を依頼する

## MCPツールの使い分け

AIコーディングエージェントが効率的に開発を支援するため、2つのMCPツールを使用します。

- **Serena MCP**: プロジェクト内のコードを構造的に理解・編集するためのツール
- **Context7 MCP**: 外部ライブラリの最新ドキュメントを取得するためのツール

MCPツールの使い分けの詳細は [`docs/memory/mcp-usage-guide.md`](docs/memory/mcp-usage-guide.md) を参照してください。

## AI駆動開発 共通ガイドライン

### 開発の基本理念
- 動くコードを書くだけでなく、品質・保守性・安全性を常に意識する
- プロジェクトの段階（プロトタイプ、MVP、本番環境）に応じて適切なバランスを取る
- 問題を見つけたら放置せず、必ず対処または明示的に記録する
- ボーイスカウトルール：コードを見つけた時よりも良い状態で残す

### エラーハンドリングの原則
- 関連が薄く見えるエラーでも必ず解決する
- エラーの抑制（try-catch で握りつぶす等）ではなく、根本原因を修正
- 早期にエラーを検出し、明確なエラーメッセージを提供
- エラーケースは必ずテストでカバーする
- 外部APIやネットワーク通信は必ず失敗する可能性を考慮

### コード品質の基準
- DRY原則：重複を避け、単一の信頼できる情報源を維持
- 意味のある変数名・関数名で意図を明確に伝える
- プロジェクト全体で一貫したコーディングスタイルを維持
- 小さな問題も放置せず、発見次第修正（Broken Windows理論）
- コメントは「なぜ」を説明し、「何を」はコードで表現

### テスト規律
- 実装詳細ではなく振る舞いをテスト
- テスト間の依存を避け、任意の順序で実行可能に
- テストは高速で、常に同じ結果を返すように
- カバレッジは指標であり、質の高いテストを重視

### 保守性とリファクタリング
- 機能追加と同時に既存コードの改善を検討
- 大規模な変更は小さなステップに分割
- 使用されていないコードは積極的に削除
- 依存関係は定期的に更新（セキュリティと互換性のため）
- 技術的負債は明示的にコメントやドキュメントに記録

### パフォーマンスの意識
- 初期段階から拡張性を考慮
- 必要になるまでリソースの読み込みを遅延
- キャッシュの有効期限と無効化戦略を明確に
- N+1問題やオーバーフェッチを避ける

### プロジェクトコンテキストの理解
- ビジネス要件と技術要件のバランスを取る
- 現在のフェーズで本当に必要な品質レベルを判断
- 時間制約がある場合でも、最低限の品質基準を維持

### トレードオフの認識
- すべてを完璧にすることは不可能（銀の弾丸は存在しない）
- 制約の中で最適なバランスを見つける
- プロトタイプなら簡潔さを、本番なら堅牢性を優先
- 妥協点とその理由を明確にドキュメント化

### 継続的な改善
- 学んだことを次のプロジェクトに活かす
- 定期的に振り返りを行い、プロセスを改善
- 新しいツールや手法を適切に評価して取り入れる
- チームや将来の開発者のために知識を文書化


## ドキュメント管理

プロジェクトのドキュメントは`docs`フォルダ以下で管理されています。各フォルダの役割と使用方法は以下の通りです。

### フォルダ構成と役割

#### `docs/spec`
仕様書関連のドキュメントを格納します。
- **役割**: 決定した仕様として更新・管理する
- **内容**: プロジェクト構造、データベース設計、インフラ情報など、実装の基準となる仕様
- **特徴**: 実装完了後も適宜更新して最新の状態を保つ

#### `docs/design`
設計関連のドキュメントを格納します。
- **役割**: 設計段階のドキュメントを保存
- **内容**: システム設計書、アーキテクチャ設計など
- **特徴**: 基本的に設計段階のものなので、情報が古い可能性がある点に注意

#### `docs/guide`
作成ガイドなどの説明・HowTo関連ドキュメントを格納します。
- **役割**: 開発者向けのガイドラインや手順書
- **内容**: API開発ガイド、環境構築手順など、開発時の参考情報
- **特徴**: 他の人に共有しておくべき知見を整理・追加する

#### `docs/memory`
AGENTS.mdから参照される参考ドキュメントを格納します。
- **役割**: AIコーディングエージェントが参照する情報
- **内容**: データベース設計、プロジェクト構造、インフラ情報、MCP利用ガイドなど
- **特徴**: AGENTS.mdから参照され、AIエージェントが理解すべき情報を格納
- **主要ドキュメント**:
  - [`database-design.md`](docs/memory/database-design.md): データベース設計
  - [`infrastructure.md`](docs/memory/infrastructure.md): インフラ情報
  - [`project-structure.md`](docs/memory/project-structure.md): プロジェクト構造
  - [`mcp-usage-guide.md`](docs/memory/mcp-usage-guide.md): MCPツールの使い分けガイド

### 典型的なユースケース

1. **仕様書作成**: `spec`フォルダで仕様書を作成する
2. **設計書作成**: 仕様書をもとに`design`フォルダに設計書を作成する
3. **実装**: 設計書を基に実装を進める
4. **仕様書更新**: 実装が終わったら`spec`フォルダの仕様書（適宜`design`フォルダの設計書も）を更新する
5. **ガイド追加**: 他の人に共有しておくべきことがあれば`guide`フォルダのドキュメントを追加・整理する
6. **メモリ追加**: AIコーディングエージェントに覚えておいてほしいことがあれば`memory`フォルダのドキュメントを追加・整理する