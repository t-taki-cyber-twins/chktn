<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エンジニア検索 - wt2m</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/project-search.css">
</head>

<body>
    <div class="container">
        <!-- ヘッダー -->
        <app-header></app-header>

        <!-- メインレイアウト -->
        <div class="main-layout">
            <!-- サイドメニュー -->
            <app-sidebar>
                <!-- 検索フォーム -->
                <div class="sidebar-search-form">
                    <div class="sidebar-title">検索条件</div>
                    <form id="search-form" class="search-form">
                        <div class="search-form-actions">
                            <button type="submit" class="btn btn-info search-form-submit">検索</button>
                            <button type="button" class="btn btn-warning search-form-reset">リセット</button>
                        </div>

                        <div class="search-form-group">
                            <label for="search-engineer-representative" class="search-form-label">担当者</label>
                            <div class="form-select-wrapper">
                                <button type="button" class="form-select-btn" id="search-engineer-representative-btn">
                                    <span class="form-select-text">選択してください</span>
                                    <span class="form-select-arrow">▼</span>
                                </button>
                                <div class="form-selected-values" id="search-engineer-representative-selected" style="display: none;">
                                    <div class="selected-values-list" id="search-engineer-representative-selected-list"></div>
                                    <button type="button" class="selected-value-remove-all" id="search-engineer-representative-remove-all">すべて解除</button>
                                </div>
                            </div>
                        </div>

                        <div class="search-form-group">
                            <label for="search-engineer-name" class="search-form-label">エンジニア名</label>
                            <input type="text" id="search-engineer-name" name="engineer-name"
                                class="search-form-input" placeholder="エンジニア名で検索">
                        </div>

                        <div class="search-form-group">
                            <label for="search-skill" class="search-form-label">スキル</label>
                            <input type="text" id="search-skill" name="skill" class="search-form-input"
                                placeholder="Java, AWSなど">
                        </div>

                        <div class="search-form-group">
                            <label for="search-status" class="search-form-label">稼働ステータス</label>
                            <select id="search-status" name="status" class="search-form-select">
                                <option value="">すべて</option>
                                <option value="available">即日可能</option>
                                <option value="working">稼働中</option>
                                <option value="leaving">離任予定</option>
                            </select>
                        </div>

                        <div class="search-form-group">
                            <label class="search-form-label">公開設定</label>
                            <div class="search-form-checkbox-group">
                                <label class="search-form-checkbox-label">
                                    <input type="checkbox" id="search-is-public" name="is-public"
                                        class="search-form-checkbox" value="true">
                                    <span>公開のみ</span>
                                </label>
                                <label class="search-form-checkbox-label">
                                    <input type="checkbox" id="search-is-private" name="is-private"
                                        class="search-form-checkbox" value="true">
                                    <span>非公開のみ</span>
                                </label>
                            </div>
                        </div>

                    </form>
                </div>
            </app-sidebar>

            <!-- コンテンツエリア -->
            <main class="content-area">
                <div class="project-search-results">
                    <div class="search-results-header">
                        <h1 class="search-results-title">エンジニア検索 - 自社のエンジニアを検索</h1>
                        <div class="search-results-actions">
                            <a href="engineer-register.html" class="btn btn-primary">新規登録</a>
                        </div>
                    </div>

                    <div class="search-results-info">
                        <div class="search-results-count">
                            <span id="results-count">◯件</span>のエンジニアが見つかりました
                        </div>
                    </div>

                    <!-- 検索結果テーブル -->
                    <div class="table-wrapper">
                        <table class="common-table" id="engineer-table">
                            <thead>
                                <tr>
                                    <th class="table-checkbox">
                                        <input type="checkbox" id="table-select-all" class="table-select-checkbox">
                                    </th>
                                    <th class="table-sortable" data-sort="name">
                                        氏名
                                        <span class="sort-icon">▼</span>
                                    </th>
                                    <th class="table-sortable" data-sort="engineer-representative">
                                        担当者
                                        <span class="sort-icon">▼</span>
                                    </th>
                                    <th class="table-sortable" data-sort="company">
                                        所属会社
                                        <span class="sort-icon">▼</span>
                                    </th>
                                    <th>スキル</th>
                                    <th class="table-sortable" data-sort="experience">
                                        経験年数
                                        <span class="sort-icon">▼</span>
                                    </th>
                                    <th class="table-sortable" data-sort="price">
                                        単価
                                        <span class="sort-icon">▼</span>
                                    </th>
                                    <th class="table-sortable" data-sort="status">
                                        ステータス
                                        <span class="sort-icon">▼</span>
                                    </th>
                                    <th class="table-sortable" data-sort="available-date">
                                        稼働可能日
                                        <span class="sort-icon">▼</span>
                                    </th>
                                    <th>公開設定</th>
                                    <th>アクション</th>
                                </tr>
                            </thead>
                            <tbody id="engineer-table-body">
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ページネーション -->
                    <app-pagination></app-pagination>
                </div>
            </main>
        </div>
    </div>

    <!-- Web Components -->
    <script type="module" src="components/app-header.js"></script>
    <script type="module" src="components/app-sidebar.js"></script>
    <script type="module" src="components/app-pagination.js"></script>
    <script type="module" src="components/app-recent-screens.js"></script>
    <script type="module" src="components/app-engineer-representative-selector.js"></script>
    <app-engineer-representative-selector></app-engineer-representative-selector>

    <script src="js/common.js"></script>
    <script type="module">
        // Engineer search page script
        import { mockEngineers } from './js/mock-data.js';

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Engineer search page loaded');
            
            // Render engineer table
            renderEngineerTable(mockEngineers);

            // Initialize Engineer Representative selection
            initEngineerRepresentativeSelection();

            // Search form submission
            const searchForm = document.getElementById('search-form');
            if (searchForm) {
                searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    performSearch();
                });
            }

            // Reset form
            const resetBtn = searchForm.querySelector('.search-form-reset');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    searchForm.reset();
                    // Clear engineer representative selection
                    const selectedList = document.getElementById('search-engineer-representative-selected-list');
                    if (selectedList) {
                        selectedList.innerHTML = '';
                        document.getElementById('search-engineer-representative-selected').style.display = 'none';
                    }
                    // Re-render all data
                    renderEngineerTable(mockEngineers);
                });
            }
        });

        /**
         * Render engineer table
         */
        function renderEngineerTable(engineers) {
            const tbody = document.getElementById('engineer-table-body');
            if (!tbody) return;

            tbody.innerHTML = engineers.map(engineer => `
                <tr data-engineer-id="${engineer.id}">
                    <td class="table-checkbox">
                        <input type="checkbox" class="row-select-checkbox" value="${engineer.id}">
                    </td>
                    <td>${escapeHtml(engineer.name)}</td>
                    <td>${Array.isArray(engineer.representatives) ? engineer.representatives.map(r => escapeHtml(r)).join(', ') : escapeHtml(engineer.representative || '')}</td>
                    <td>${escapeHtml(engineer.company)}</td>
                    <td>${escapeHtml(engineer.skills)}</td>
                    <td>${escapeHtml(engineer.experience)}</td>
                    <td>${escapeHtml(engineer.price)}</td>
                    <td>
                        <span class="badge badge-status-${engineer.status}">${engineer.statusLabel}</span>
                    </td>
                    <td>${escapeHtml(engineer.availableDate)}</td>
                    <td>
                        <span class="badge badge-${engineer.isPublic ? 'public' : 'private'}">${engineer.isPublic ? '公開' : '非公開'}</span>
                    </td>
                    <td>
                        <div class="table-actions">
                            <a href="engineer-edit.html" class="btn btn-primary btn-sm">編集</a>
                            <button type="button" class="btn btn-danger btn-sm engineer-delete-btn"
                                data-engineer-id="${engineer.id}">削除</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Re-attach event listeners if needed (e.g. delete buttons)
            attachTableEventListeners();
        }

        function attachTableEventListeners() {
            document.querySelectorAll('.engineer-delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.engineerId;
                    if(confirm('本当に削除しますか？')) {
                        console.log('Delete engineer:', id);
                        // In a real app, we would delete from data and re-render
                        e.target.closest('tr').remove();
                    }
                });
            });
        }

        /**
         * Initialize Engineer Representative selection
         */
        function initEngineerRepresentativeSelection() {
            const selectBtn = document.getElementById('search-engineer-representative-btn');
            const selectedDiv = document.getElementById('search-engineer-representative-selected');
            const selectedList = document.getElementById('search-engineer-representative-selected-list');
            const removeAllBtn = document.getElementById('search-engineer-representative-remove-all');
            const selectorComponent = document.querySelector('app-engineer-representative-selector');

            let selectedItems = []; // 選択されたアイテムの配列

            // 選択されたアイテムを表示
            function renderSelectedItems() {
                if (selectedItems.length === 0) {
                    selectedDiv.style.display = 'none';
                    return;
                }

                selectedDiv.style.display = 'block';
                selectedList.innerHTML = '';

                selectedItems.forEach(item => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-value-tag';
                    tag.innerHTML = `
                        <span class="selected-value-text">${escapeHtml(item.name)}</span>
                        <button type="button" class="selected-value-remove" data-item-id="${item.id}">×</button>
                    `;

                    // 個別削除ボタン
                    const removeBtn = tag.querySelector('.selected-value-remove');
                    removeBtn.addEventListener('click', () => {
                        selectedItems = selectedItems.filter(i => i.id !== item.id);
                        renderSelectedItems();
                    });

                    selectedList.appendChild(tag);
                });
            }

            // 選択ボタンクリック
            if (selectBtn) {
                selectBtn.addEventListener('click', function() {
                    if (selectorComponent) {
                        selectorComponent.open(selectedItems, function(newSelectedItems) {
                            selectedItems = newSelectedItems;
                            renderSelectedItems();
                        });
                    }
                });
            }

            // すべて解除ボタン
            if (removeAllBtn) {
                removeAllBtn.addEventListener('click', function() {
                    selectedItems = [];
                    renderSelectedItems();
                });
            }
        }

        /**
         * Perform search
         */
        function performSearch() {
            const formData = new FormData(document.getElementById('search-form'));
            const searchParams = {};

            // Get form data
            for (const [key, value] of formData.entries()) {
                if (value) {
                    searchParams[key] = value;
                }
            }

            // Get engineer representative selection
            const selectedRepresentatives = [];
            const selectedList = document.getElementById('search-engineer-representative-selected-list');
            if (selectedList) {
                const tags = selectedList.querySelectorAll('.selected-value-text');
                tags.forEach(tag => {
                    selectedRepresentatives.push(tag.textContent);
                });
            }
            if (selectedRepresentatives.length > 0) {
                searchParams['engineer-representative'] = selectedRepresentatives;
            }

            console.log('検索パラメータ:', searchParams);
            
            // Filter mock data (Simple implementation)
            const filtered = mockEngineers.filter(engineer => {
                let match = true;
                if (searchParams['engineer-name'] && !engineer.name.includes(searchParams['engineer-name'])) match = false;
                if (searchParams['status'] && engineer.status !== searchParams['status']) match = false;
                
                // Filter by representatives (multiple representatives support)
                if (searchParams['engineer-representative'] && searchParams['engineer-representative'].length > 0) {
                    const engineerRepresentatives = Array.isArray(engineer.representatives) 
                        ? engineer.representatives 
                        : (engineer.representative ? [engineer.representative] : []);
                    const selectedRepresentatives = searchParams['engineer-representative'];
                    // Check if any selected representative matches any engineer representative
                    const hasMatchingRepresentative = selectedRepresentatives.some(selected => 
                        engineerRepresentatives.some(rep => rep === selected)
                    );
                    if (!hasMatchingRepresentative) match = false;
                }
                
                return match;
            });
            
            renderEngineerTable(filtered);
        }

        /**
         * HTML escape utility
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>