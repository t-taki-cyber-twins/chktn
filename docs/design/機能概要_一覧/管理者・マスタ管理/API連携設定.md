# API連携設定画面 (api-integration.html)

## 概要
外部API（Zoom、Google Meets、Teams等）との連携を設定・管理する画面です。OAuth認証を通じてWeb会議ツールと連携し、面談URLの自動生成など業務効率化を実現します。

## 機能の目的
- Web会議ツール（Zoom、Google Meets、Microsoft Teams）との連携を設定する。
- OAuth認証を使用して、安全かつ簡単に外部APIとの接続を確立する。
- 面談編集画面で会議URLを自動生成し、手動入力の手間を削減する。

## ユースケース
- **Zoom連携の設定**: テナント管理者は、Zoomアカウントを連携し、面談時にZoom会議URLを自動生成できるようにする。
- **Google Meets連携の設定**: テナント管理者は、Googleアカウントを連携し、Google Meets会議URLを自動生成できるようにする。
- **Teams連携の設定**: テナント管理者は、Microsoftアカウントを連携し、Teams会議URLを自動生成できるようにする。
- **連携の解除**: テナント管理者は、不要になった連携を解除し、アクセス権限を削除する。
- **連携状態の確認**: テナント管理者は、各Web会議ツールの連携状態（接続済み/未接続）を確認する。

## EARS 記法による要件定義

### API連携設定の表示
- **WHEN** テナント管理者がAPI連携設定画面を開いた際
  - **THEN** システムは`app-api-integration`コンポーネントを表示する
  - **AND** 各Web会議ツール（Zoom、Google Meets、Teams）の連携状態を表示する

### OAuth認証フロー
- **WHEN** テナント管理者が未連携のWeb会議ツールの「連携する」ボタンをクリックした際
  - **THEN** システムは該当するサービスのOAuth認証ページを新しいウィンドウで開く
  - **AND** ユーザーにサービスへのログインと権限付与を促す

- **WHEN** ユーザーがOAuth認証ページで権限を付与した際
  - **THEN** システムは認証コードを受け取る
  - **AND** 認証コードを使用してアクセストークンを取得する
  - **AND** アクセストークンをデータベースに安全に保存する
  - **AND** 連携状態を「接続済み」に更新する

- **WHEN** OAuth認証に失敗した際
  - **THEN** システムはエラーメッセージを表示する
  - **AND** 連携状態を「未接続」のままにする

### 連携の解除
- **WHEN** テナント管理者が接続済みのWeb会議ツールの「連携解除」ボタンをクリックした際
  - **THEN** システムは確認ダイアログを表示する
  - **IF** 管理者が解除を確認した場合
    - **THEN** システムは保存されているアクセストークンを削除する
    - **AND** 外部APIに対してトークンの無効化をリクエストする
    - **AND** 連携状態を「未接続」に更新する

### 会議URL自動生成（面談編集画面との連携）
- **WHEN** ユーザーが面談編集画面で会議ツールを選択した際
  - **IF** 該当するWeb会議ツールが連携済みの場合
    - **THEN** システムは外部APIを呼び出して新しい会議URLを生成する
    - **AND** 生成されたURLを面談情報に自動入力する
  - **ELSE** 該当するWeb会議ツールが未連携の場合
    - **THEN** システムはエラーメッセージを表示し、連携設定を促す

## 機能一覧

| 画面 | 機能名 | 概要 | 優先度 | アクター | 備考 |
|---|---|---|---|---|---|
| API連携設定 | 連携状態表示 | 各Web会議ツールの連携状態を表示する | 必須 | システム | `app-api-integration`コンポーネントを使用 |
| API連携設定 | OAuth認証開始 | 「連携する」ボタンでOAuth認証フローを開始する | 必須 | テナント管理者 | 新しいウィンドウで認証ページを開く |
| API連携設定 | アクセストークン取得・保存 | OAuth認証後にアクセストークンを取得・保存する | 必須 | システム | 安全な保存方法（暗号化）要確認 |
| API連携設定 | 連携解除 | 接続済みの連携を解除する | 必須 | テナント管理者 | 確認ダイアログと外部APIへの無効化リクエスト |
| API連携設定 | エラーハンドリング | OAuth認証失敗時やAPI呼び出しエラー時の処理 | 必須 | システム | ユーザーに分かりやすいエラーメッセージ |
| 面談編集画面（連携機能） | 会議URL自動生成 | 連携済みツールで会議URLを自動生成する | 必須 | システム | 外部API呼び出し |

## ユーザ確認事項
- **OAuth認証のフロー**: 各Web会議ツール（Zoom、Google Meets、Teams）のOAuth認証の具体的な実装方法や必要な権限スコープの確認が必要です。
- **アクセストークンの管理**: アクセストークンの保存方法（暗号化方式）、リフレッシュトークンの扱い、トークンの有効期限管理について確認が必要です。
- **会議作成のパラメータ**: 会議URL生成時に設定するパラメータ（会議名、開始時刻、時間等）をどのように決定するかの確認が必要です。
- **エラー処理**: OAuth認証失敗、API呼び出しエラー、トークン期限切れなど、各種エラー時の具体的な処理方法の確認が必要です。
- **連携範囲**: API連携はテナント単位か、ユーザー単位か、またはその両方をサポートするかの確認が必要です。
- **セキュリティ**: アクセストークンの暗号化、CSRF対策、OAuth state パラメータの使用など、セキュリティ対策の確認が必要です。
- **複数アカウント対応**: 同じWeb会議ツールで複数のアカウントを連携できるかどうかの確認が必要です。
- **コンポーネントの実装**: `app-api-integration`コンポーネントの詳細な仕様や、面談編集画面との連携方法について確認が必要です。
